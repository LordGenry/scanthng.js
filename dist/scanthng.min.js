!function(a,b){"use strict";"function"==typeof define&&define.amd?define(b()):a.EVT.Scan=a.Evrythng.Scan=b()}(this,function(){var a,b,c;return function(d){function e(a,b){return v.call(a,b)}function f(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o=b&&b.split("/"),p=t.map,q=p&&p["*"]||{};if(a){for(a=a.split("/"),g=a.length-1,t.nodeIdCompat&&x.test(a[g])&&(a[g]=a[g].replace(x,"")),"."===a[0].charAt(0)&&o&&(n=o.slice(0,o.length-1),a=n.concat(a)),k=0;k<a.length;k++)if("."===(m=a[k]))a.splice(k,1),k-=1;else if(".."===m){if(0===k||1===k&&".."===a[2]||".."===a[k-1])continue;k>0&&(a.splice(k-1,2),k-=2)}a=a.join("/")}if((o||q)&&p){for(c=a.split("/"),k=c.length;k>0;k-=1){if(d=c.slice(0,k).join("/"),o)for(l=o.length;l>0;l-=1)if((e=p[o.slice(0,l).join("/")])&&(e=e[d])){f=e,h=k;break}if(f)break;!i&&q&&q[d]&&(i=q[d],j=k)}!f&&i&&(f=i,h=j),f&&(c.splice(0,h,f),a=c.join("/"))}return a}function g(a,b){return function(){var c=w.call(arguments,0);return"string"!=typeof c[0]&&1===c.length&&c.push(null),o.apply(d,c.concat([a,b]))}}function h(a){return function(b){return f(b,a)}}function i(a){return function(b){r[a]=b}}function j(a){if(e(s,a)){var b=s[a];delete s[a],u[a]=!0,n.apply(d,b)}if(!e(r,a)&&!e(u,a))throw new Error("No "+a);return r[a]}function k(a){var b,c=a?a.indexOf("!"):-1;return c>-1&&(b=a.substring(0,c),a=a.substring(c+1,a.length)),[b,a]}function l(a){return a?k(a):[]}function m(a){return function(){return t&&t.config&&t.config[a]||{}}}var n,o,p,q,r={},s={},t={},u={},v=Object.prototype.hasOwnProperty,w=[].slice,x=/\.js$/;p=function(a,b){var c,d=k(a),e=d[0],g=b[1];return a=d[1],e&&(e=f(e,g),c=j(e)),e?a=c&&c.normalize?c.normalize(a,h(g)):f(a,g):(a=f(a,g),d=k(a),e=d[0],a=d[1],e&&(c=j(e))),{f:e?e+"!"+a:a,n:a,pr:e,p:c}},q={require:function(a){return g(a)},exports:function(a){var b=r[a];return void 0!==b?b:r[a]={}},module:function(a){return{id:a,uri:"",exports:r[a],config:m(a)}}},n=function(a,b,c,f){var h,k,m,n,o,t,v,w=[],x=typeof c;if(f=f||a,t=l(f),"undefined"===x||"function"===x){for(b=!b.length&&c.length?["require","exports","module"]:b,o=0;o<b.length;o+=1)if(n=p(b[o],t),"require"===(k=n.f))w[o]=q.require(a);else if("exports"===k)w[o]=q.exports(a),v=!0;else if("module"===k)h=w[o]=q.module(a);else if(e(r,k)||e(s,k)||e(u,k))w[o]=j(k);else{if(!n.p)throw new Error(a+" missing "+k);n.p.load(n.n,g(f,!0),i(k),{}),w[o]=r[k]}m=c?c.apply(r[a],w):void 0,a&&(h&&h.exports!==d&&h.exports!==r[a]?r[a]=h.exports:m===d&&v||(r[a]=m))}else a&&(r[a]=c)},a=b=o=function(a,b,c,e,f){if("string"==typeof a)return q[a]?q[a](b):j(p(a,l(b)).f);if(!a.splice){if(t=a,t.deps&&o(t.deps,t.callback),!b)return;b.splice?(a=b,b=c,c=null):a=d}return b=b||function(){},"function"==typeof c&&(c=e,e=f),e?n(d,a,b,c):setTimeout(function(){n(d,a,b,c)},4),o},o.config=function(a){return o(a)},a._defined=r,c=function(a,b,c){if("string"!=typeof a)throw new Error("See almond README: incorrect module build, no module name");b.splice||(c=b,b=[]),e(r,a)||e(s,a)||(s[a]=[a,b,c])},c.amd={jQuery:!0}}(),c("almond",function(){}),c("utils",[],function(){"use strict";return{isFunction:function(a){return"[object Function]"==Object.prototype.toString.call(a)},isString:function(a){return"[object String]"==Object.prototype.toString.call(a)},isArray:function(a){return"[object Array]"==Object.prototype.toString.call(a)},isObject:function(a){return a===Object(a)&&!this.isArray(a)},isDataUrl:function(a){return"[object String]"==Object.prototype.toString.call(a)&&a.match(/^\s*data:image\/(\w+)(;charset=[\w-]+)?(;base64)?,/)},extend:function(a,b,c){var d;if(c)d=a;else{d={};for(var e in a)d[e]=a[e]}for(var f in b)b.hasOwnProperty(f)&&(d[f]=b[f]);return d},isFirefoxMobileBrowser:function(){var a,b=navigator.userAgent.toLowerCase();return b.indexOf("firefox")>-1&&b.indexOf("mobile")>-1&&(a=b.match(/firefox\/([\d.]+)/)[1],a.split(".")[0]>=10)},isAndroidBrowser:function(){var a=window.navigator.userAgent.match(/Android.*AppleWebKit\/([\d.]+)/);return a&&a[1]<537},restoreUser:function(a,b){var c,d;return c=window.localStorage?this.readStorage("scanthng-"+a.id):this.readCookie("scanthng-"+a.id),this.isObject(c)&&(d=new b(c,a)),d},storeUser:function(a,b){var c={id:b.id,apiKey:b.apiKey};window.localStorage?this.writeStorage("scanthng-"+a.id,c):this.writeCookie("scanthng-"+a.id,c)},writeStorage:function(a,b){window.localStorage.setItem(a,JSON.stringify(b))},readStorage:function(a){var b=window.localStorage.getItem(a);return JSON.parse(b)},writeCookie:function(a,b){document.cookie=encodeURI(a)+"="+encodeURI(JSON.stringify(b))+"; expires=Tue, 19 Jan 2038 03:14:07 GMT; path=/"},readCookie:function(a){var b=decodeURI(document.cookie.replace(new RegExp("(?:^|.*;\\s*)"+decodeURI(a).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=\\s*((?:[^;](?!;))*[^;]?).*"),"$1"));return JSON.parse(b)}}}),function(){function a(a){var b=a.naturalWidth;if(b*a.naturalHeight>1048576){var c=document.createElement("canvas");c.width=c.height=1;var d=c.getContext("2d");return d.drawImage(a,1-b,0),0===d.getImageData(0,0,1,1).data[3]}return!1}function b(a,b,c){var d=document.createElement("canvas");d.width=1,d.height=c;var e=d.getContext("2d");e.drawImage(a,0,0);for(var f=e.getImageData(0,0,1,c).data,g=0,h=c,i=c;i>g;){0===f[4*(i-1)+3]?h=i:g=i,i=h+g>>1}var j=i/c;return 0===j?1:j}function d(a,b,c){var d=document.createElement("canvas");return e(a,d,b,c),d.toDataURL("image/jpeg",b.quality||.8)}function e(c,d,e,g){var h=c.naturalWidth,i=c.naturalHeight;if(h+i){var j=e.width,k=e.height,l=d.getContext("2d");l.save(),f(d,l,j,k,e.orientation);a(c)&&(h/=2,i/=2);var m=1024,n=document.createElement("canvas");n.width=n.height=m;for(var o=n.getContext("2d"),p=g?b(c,h,i):1,q=Math.ceil(m*j/h),r=Math.ceil(m*k/i/p),s=0,t=0;s<i;){for(var u=0,v=0;u<h;)o.clearRect(0,0,m,m),o.drawImage(c,-u,-s),l.drawImage(n,0,0,m,m,v,t,q,r),u+=m,v+=q;s+=m,t+=r}l.restore(),n=o=null}}function f(a,b,c,d,e){switch(e){case 5:case 6:case 7:case 8:a.width=d,a.height=c;break;default:a.width=c,a.height=d}switch(e){case 2:b.translate(c,0),b.scale(-1,1);break;case 3:b.translate(c,d),b.rotate(Math.PI);break;case 4:b.translate(0,d),b.scale(1,-1);break;case 5:b.rotate(.5*Math.PI),b.scale(1,-1);break;case 6:b.rotate(.5*Math.PI),b.translate(0,-d);break;case 7:b.rotate(.5*Math.PI),b.translate(c,-d),b.scale(-1,1);break;case 8:b.rotate(-.5*Math.PI),b.translate(-c,0)}}function g(a){if(window.Blob&&a instanceof Blob){if(!h)throw Error("No createObjectURL function found to create blob url");var b=new Image;b.src=h.createObjectURL(a),this.blob=a,a=b}if(!a.naturalWidth&&!a.naturalHeight){var c=this;a.onload=a.onerror=function(){var a=c.imageLoadListeners;if(a){c.imageLoadListeners=null;for(var b=0,d=a.length;b<d;b++)a[b]()}},this.imageLoadListeners=[]}this.srcImage=a}var h=window.URL&&window.URL.createObjectURL?window.URL:window.webkitURL&&window.webkitURL.createObjectURL?window.webkitURL:null;g.prototype.render=function(a,b,c){if(this.imageLoadListeners){var f=this;return void this.imageLoadListeners.push(function(){f.render(a,b,c)})}b=b||{};var g=this.srcImage.naturalWidth,i=this.srcImage.naturalHeight,j=b.width,k=b.height,l=b.maxWidth,m=b.maxHeight,n=!this.blob||"image/jpeg"===this.blob.type;j&&!k?k=i*j/g<<0:k&&!j?j=g*k/i<<0:(j=g,k=i),l&&j>l&&(j=l,k=i*j/g<<0),m&&k>m&&(k=m,j=g*k/i<<0);var o={width:j,height:k};for(var p in b)o[p]=b[p];var q=a.tagName.toLowerCase();"img"===q?a.src=d(this.srcImage,o,n):"canvas"===q&&e(this.srcImage,a,o,n),"function"==typeof this.onrender&&this.onrender(a),c&&c(),this.blob&&(this.blob=null,h.revokeObjectURL(this.srcImage.src))},"function"==typeof c&&c.amd?c("megapix",[],function(){return g}):"object"==typeof exports?module.exports=g:this.MegaPixImage=g}(),c("polyfill",[],function(){"use strict";HTMLCanvasElement.prototype.toBlob||Object.defineProperty(HTMLCanvasElement.prototype,"toBlob",{value:function(a,b,c){for(var d=atob(this.toDataURL(b,c).split(",")[1]),e=d.length,f=new Uint8Array(e),g=0;g<e;g++)f[g]=d.charCodeAt(g);a(new Blob([f],{type:b||"image/png"}))}})}),c("prepare",["utils","megapix","polyfill"],function(a,b){"use strict";function c(){return new Promise(function(b,c){var d=n.id?n.id:"scanthng"+Date.now(),e=document.createElement("form"),f=document.createElement("input");e.setAttribute("id",d),e.setAttribute("class","scanThng_form"),f.setAttribute("type","file"),f.setAttribute("name","scanThng_upload"),f.setAttribute("accept","image/*"),f.setAttribute("capture","camera"),n.invisible&&(e.style.visibility="hidden"),e.appendChild(f);var g=document.getElementsByClassName("scanThng_form");if(g.length)for(var h=0,i=g.length;h<i;h++)g[h]&&g[h].parentElement&&g[h].parentElement.removeChild(g[h]);if(document.getElementsByTagName("body")[0].appendChild(e),f.addEventListener("change",function(){var a=this.files[0];a||c(new Error("No file selected.")),b(a)}),a.isAndroidBrowser()||a.isFirefoxMobileBrowser()){var j=function(){f.click()};window.setTimeout(j.bind(this,d),800)}else f.click()})}function d(a){return n.imageConversion.exportFormat=a.type,new Promise(function(b,c){var d=new FileReader;d.onload=function(a){b(a.target.result)},d.onerror=function(a){c(a)},d.readAsDataURL(a)})}function e(a){return new Promise(function(b,c){var d=document.createElement("img");d.onload=function(){if("naturalHeight"in this){if(this.naturalHeight+this.naturalWidth===0)return void this.onerror()}else if(this.width+this.height===0)return void this.onerror();b(d)},d.onerror=function(){c(new Error("Invalid image"))},d.src=a})}function f(a){return new Promise(function(c){var d=document.createElement("canvas"),e=Math.max(n.imageConversion.resizeTo,m),f=a.width/a.height,h=e/Math.min(a.width,a.height),i=f>1?a.width*h:e,j=f>1?e:a.height*h;new b(a).render(d,{width:i,height:j}),n.imageConversion.greyscale&&g(d),c(d)})}function g(a){for(var b=a.getContext("2d"),c=b.getImageData(0,0,a.width,a.height),d=c.data,e=0,f=d.length;e<f;e+=4){var g=.3*d[e]+.59*d[e+1]+.11*d[e+2];d[e]=g,d[e+1]=g,d[e+2]=g}return b.putImageData(c,0,0),a}function h(a){return new Promise(function(b){a.toBlob(function(c){a=null,b(c)},n.imageConversion.exportFormat,n.imageConversion.exportQuality)})}function i(b){return n={invisible:b.hasOwnProperty("invisible")?b.invisible:l.invisible,imageConversion:a.extend(l.imageConversion,b.imageConversion)}}function j(a){return i(a),c().then(d)}function k(a,b){return b&&i(b),e(a).then(f).then(h).then(function(a){return{image:a}})}var l={invisible:!0,imageConversion:{greyscale:!0,resizeTo:240,exportFormat:"image/jpeg",exportQuality:.8}},m=144,n={};return{getFile:j,processImage:k}}),c("scanthng",["utils","prepare"],function(a,b){"use strict";function c(b,c){var d=a.extend(b,c);return d.imageConversion=a.extend(b.imageConversion,c&&c.imageConversion||{}),c&&c.imageConversion&&c.imageConversion.resizeTo&&(d.imageConversion.resizeTo=Math.max(d.imageConversion.resizeTo,c.imageConversion.resizeTo)),d}function d(a){var b;["debug","perPage","filter"].forEach(function(a){void 0!==p[a]&&(b=b||{},b[a]=p[a])});var c={url:u,method:a?"post":"get",authorization:o.apiKey,params:b};return a&&(c.formData=a),n.api(c)}function e(a,b,c){var d=c[a](b.id),e=a.charAt(0).toUpperCase()+a.slice(1);return new n.Entity[e](b,d)}function f(b){return g().then(function(c){return b.map(function(b){return a.isObject(c)&&(b.user=c,b.results=b.results.map(function(a){return["product","thng"].forEach(function(b){a[b]&&(a[b]=e(b,a[b],c))}),a})),b})})}function g(){if(p.createAnonymousUser){var b=a.restoreUser(o,n.User);return a.isObject(b)?m.resolve(b):o.appUser().create({anonymous:!0}).then(function(b){return a.storeUser(o,b),b})}return m.resolve()}function h(a){return d(a).then(f)}function i(a,b,c,d,e){var f=b.getContext("2d");if(b.width=c.videoWidth,b.height=c.videoHeight,f.drawImage(c,0,0),"2d"===d.method&&"qr_code"===d.type){var g;try{g=f.getImageData(0,0,c.videoWidth,c.videoHeight)}catch(a){return void console.log("Failed to getImageData - device may not be ready.")}var h=window.jsQR(g.data,g.width,g.height);return void(h&&e(h.data))}a.scan(b.toDataURL()).then(function(a){a.length&&e(a)}).catch(function(a){if(!a.errors||!a.errors[0].includes("lacking sufficient detail"))throw a})}function j(a,b,c){var d=document.getElementById(q);return d.srcObject=b,d.play(),new m(function(e,f){var g=s;"2d"===c.filter.method&&"qr_code"===c.filter.type&&(g=r);var h=document.createElement("canvas"),j=setInterval(function(){try{i(a,h,d,c.filter,function(f){if(clearInterval(j),b.getVideoTracks()[0].stop(),d.parentElement.removeChild(d),"string"==typeof f)return c.filter="type=qr_code&value="+f,void a.identify(c).then(e);e(f)})}catch(a){f(a)}},g)})}function k(a){if(!document.getElementById(q)){const b=document.createElement("video");b.id=q,b.autoPlay=!0,b.playsInline=!0,document.getElementById(a).appendChild(b)}}function l(a){if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)return console.log("getUserMedia() is not supported with this browser; falling back to Media Capture."),this.scan(a);if(!window.jsQR)throw new Error("jsQR (https://github.com/cozmo/jsQR) not found. You must include it in a <script> tag.");if(!document.getElementById(a.containerId))throw new Error("Please specify 'containerId' where the video element can be added as a child");if(!a.filter.method||!a.filter.type)throw new Error("Please specify both 'method' and 'type' in 'filter'.");a.filter.method=a.filter.method.toLowerCase(),a.filter.type=a.filter.type.toLowerCase();var b=this;return navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}}).then(function(c){return k(a.containerId),j(b,c,a)}).then(f)}var m,n,o,p,q="scanthng-video-"+Date.now(),r=300,s=2e3,t={invisible:!0,imageConversion:{greyscale:!0,resizeTo:600,exportQuality:.8},createAnonymousUser:!1},u="/scan/identifications",v={version:"3.1.0",settings:t,setup:function(b){if(!a.isObject(b))throw new TypeError("Setup should be called with an options object.");return this.settings=c(this.settings,b),this.settings},install:function(d,e){var f=this;m=d,n=e,n.App.prototype.redirect=function(a){window.location.href=a},n.App.prototype.identify=function(b,d,e){if(o=this,!a.isObject(b)||!b.hasOwnProperty("filter"))throw new Error("Missing filter option.");return p=c(f.settings,b),new m(function(b,c){h().then(function(c){a.isFunction(d)&&d(c),b(c)},function(b){a.isFunction(e)&&e(b),c(b)})})},n.App.prototype.scanStream=l,n.App.prototype.scan=function(d,e,g,i){var j,k,l,n;o=this,a.isFunction(arguments[0])?(l=arguments[0],n=arguments[1]):a.isObject(arguments[0])?(k=arguments[0],l=arguments[1],n=arguments[2]):(j=arguments[0],a.isFunction(arguments[1])?(l=arguments[1],n=arguments[2]):(k=arguments[1],l=arguments[2],n=arguments[3])),p=c(f.settings,k);var q={invisible:p.invisible,imageConversion:p.imageConversion};return new m(function(c,d){var e;if(a.isString(j)){if(!a.isDataUrl(j))return d(new Error("Invalid Image Data URL."));e=b.processImage(j,q)}else e=b.getFile(q).then(b.processImage);e.then(h).then(function(b){a.isFunction(l)&&l(b),c(b)},function(b){a.isFunction(n)&&n(b),d(b)})})}}};return v.$inject=["promise","evrythng"],v.insertVideoElement=k,v}),b("scanthng")});